const catchAsync = require('../middleware/catchAsync');
const Product=require('../models/productModel');
const ExpressError = require('../utils/ExpressError');
const ApiFeatures=require('../utils/ApiFeatures');
exports.getAllProducts=catchAsync(async (req,res)=>{
  const limit=5;
  const apiFeatures=new ApiFeatures(Product.find(),req.query).search().filter().pagination(limit);
  const products=await apiFeatures.query;
    res.status(200).json({
      products
    })})


exports.showProduct=catchAsync(async(req,res,next)=>{
  const product=await Product.findById(req.params.id);
  if(!product){
    return next(new ExpressError("product not found",404));
  }
  res.status(200).json({
    success:true,
    product,
  });
}     
)

//admin
exports.addProduct=catchAsync(async(req,res,next)=>{
    const newProduct=req.body
    console.log(req.user.id);
    newProduct.author=req.user.id
    let b=await Product.insertMany(newProduct);
    if(b){
     res.status(200).json({
       newProduct,
     })
   }
   
})

exports.editProduct=catchAsync(async (req,res,next)=>{
  let product=await Product.findById(req.params.id);
  if(!product){
    return next(new ExpressError("product not found",404));
  }
  product= await Product.findByIdAndUpdate(req.params.id,req.body,{
    new:true,
    runValidators:true,
    useFindAndModify:false
  });
  res.status(200).json({  
    product
  })
})

exports.deleteProduct=catchAsync(async (req,res,next)=>{
  const product=await Product.findById(req.params.id);
  if(!product){
    return next(new ExpressError("product not found",404));
  }
  await Product.findByIdAndDelete(req.params.id);
  res.status(200).json({
    success:true,
    message:"product deleted successfully"
  })

})
